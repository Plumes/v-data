<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="assets/pure-0.6.0-min.css">
    <link href="assets/googlefont.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/style2.css">

    <script src='assets/jquery-3.1.0.slim.min.js'></script>
    <script src="assets/vue.js"></script>
    <script src="assets/config.js"></script>
    <script src="assets/vue-resource-0.9.3.min.js"></script>
    <script src="data/date/date_list.js"></script>
    <script src="assets/map_style.js"></script>
    <script src="//cdn.bootcss.com/echarts/3.2.2/echarts.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=30pq91QAo0Cp7izhHpgmgvR8"></script>

    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>

</head>
<body>
<div id="navbar">
    <div class="title">
        <span>基于手机信令数据的城域出行模式分析系统</span>
    </div>
</div>
<div class="pure-menu" id="left-nav">
    <ul class="pure-menu-list">
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">数据概况</a></li>
        <li class="pure-menu-item current"><a href="phone_trip.html" class="pure-menu-link">单日出行链</a></li>
        <li class="pure-menu-item pure-menu-has-submenu" >

            <a href="#" class="pure-menu-link">热点区域<i class="material-icons">keyboard_arrow_right</i></a>
            <ul class="submenu">
                <li class="pure-menu-item"><a href="matrix_home.html" class="pure-menu-link">居住区</a></li>
                <li class="pure-menu-item"><a href="matrix_work.html" class="pure-menu-link">工作区</a></li>
            </ul>
        </li>

        <li class="pure-menu-item pure-menu-has-submenu">
            <a href="#" class="pure-menu-link">OD热度<i class="material-icons">keyboard_arrow_right</i></a>
            <ul class="submenu">
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">上班OD</a></li>
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">回家OD</a></li>
                <li class="pure-menu-item"><a href="#" class="pure-menu-link">全天OD</a></li>
            </ul>
        </li>

        <li class="pure-menu-item"><a href="od_multi_routes.html" class="pure-menu-link">OD轨迹</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">出行模式</a></li>
    </ul>
</div>
<div class="container">
    <div class="right-col">
        <div class="panel">
            <div id="calendar">
                <div class="headbar">
                    <div class="control" v-on:click="calYear(-1)"><i class="material-icons">first_page</i></div>
                    <div class="control" v-on:click="calMonth(-1)"><i class="material-icons">chevron_left</i></div>
                    <div class="control date-title">
                        <div class="year">{{ year }} 年</div>
                        <div class="month">&nbsp;{{ month }} 月</div>
                    </div>
                    <div class="control" v-on:click="calMonth(1)"><i class="material-icons">chevron_right</i></div>
                    <div class="control" v-on:click="calYear(1)"><i class="material-icons">last_page</i></div>
                </div>

                <table class="week">
                    <thead>
                    <tr>
                        <th v-for="day_name in day_name_list">{{ day_name }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="week in week_list">

                        <td v-for="day in week" v-bind:class="{'has-data' : validate_date(day), 'current': year*10000+month*100+day==current_day}" v-on:click="loadData(day)"><a v-if="day > 0">{{ day }}</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="panel" style="padding: 0;">
            <div class="omnibox-container">
                <div class="omnibox">
                    <div class="resultbox">
                        <i class="material-icons">account_box</i>
                        <div class="result">{{ current_user }}</div>
                        <i class="material-icons arrow" style="float: right;display: block;">keyboard_arrow_down</i>
                    </div>
                    <ul class="suggestion-list">
                        <li class="suggestion" v-on:click="loadTripMap(0)"><i class="material-icons">fiber_manual_record</i>全部</li>
                        <li class="suggestion" v-for="user in user_list" v-on:click="loadTripMap(user)" ><i class="material-icons" v-bind:style="{color: user_color_list[user]}">fiber_manual_record</i>{{ user }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="panel" style="height: 300px;display: none;">
            <div id="fig-1" style="height: 100%"></div>
        </div>
        <div class="panel" id="fig-2" style="height: 300px;display: none;">

        </div>
        <div class="panel" id="fig-3" style="height: 300px;display: none;">

        </div>
    </div>

    <div class="left-col">
        <div id="bmap" style="height: 100%;">

        </div>
    </div>
</div>
<script>
    $(".pure-menu-has-submenu>a").click(function () {
        $(this).parent().toggleClass('pure-menu-show-submenu');
        $(this).parent().find(".submenu").toggle();
    });
    Vue.config.devtools = true;

    var app = new Vue({
        el:'body',
        data: {
            year : 0,
            month : 0,
            day_name_list : ['一','二','三','四','五','六','日'],
            valid_date: [],
            data_url:  base_site + 'data/',
            user_list:[],
            user_color_list: {},
            current_user:'全部',
            mapv:{
                el:{},
                raw_data:{},
                data:{
                    special_point_list:[],
                    normal_point_list:[],
                    arc_list:[]
                }
            },
            figure_1:{
                el:{},
                data: {}
            },
            figure_2:{
                el:{},
                data: {}
            },
            figure_3:{
                el:{},
                data: {}
            },
            current_day:-1
        },
        computed: {
            week_list: function () {
                var d= new Date(this.year, this.month, 0);
                var day_num =  d.getDate();
                var first_day = new Date(this.year, this.month-1, 1);
                var first_day_name = first_day.getDay()==0?7:first_day.getDay();
                var week_num = Math.ceil((day_num - (8 - first_day_name)) / 7.0) + 1;
                var week_list = [];
                var day_index = 1;

                var first_week = [];
                for(var i=1;i<first_day_name;i++) {
                    first_week.push(0-i);
                }
                for(var i=first_day_name;i<8;i++) {
                    first_week.push(day_index++);
                }
                week_list.push(first_week);

                for(var i=1;i<week_num;i++) {
                    var week = [];
                    for(var j=1;j<8 && day_index<=day_num;j++) {
                        week.push(day_index++);
                    }
                    week_list.push(week);
                }

                //计算有数据的日期
                this.valid_date = [];
                for(var i in opt_date) {
                    var f_day = this.year * 10000 + this.month * 100;
                    var t_date = parseInt(opt_date[i][1]);
                    if( t_date > f_day && t_date < f_day+32) {
                        this.valid_date.push(t_date%100);
                    }
                }

                return week_list;
            }
        },
        compiled: function () {
            if(opt_date===undefined) {
                var d = new Date();
                this.year = d.getFullYear();
                this.month = d.getMonth()+1;
            } else {
                this.year = parseInt(opt_date[0][1]/10000);
                this.month = parseInt(opt_date[0][1]/100)%100;
            }

        },
        ready: function () {
            this.mapv.el = echarts.init(document.getElementById('bmap'));
            this.figure_1.el = echarts.init(document.getElementById('fig-1'));
            this.figure_2.el = echarts.init(document.getElementById('fig-2'));
            this.figure_3.el = echarts.init(document.getElementById('fig-3'));

            this.valid_date = [opt_date[0][1]%100];
            this.loadData(opt_date[0][1]%100);
        },
        methods: {
            calMonth: function (val) {
                //月份的加减运算
                var month = this.month + val;
                if(month<1) {
                    month += 12;
                    this.year -= 1;
                } else if(month>12) {
                    month -= 12;
                    this.year += 1;
                }
                this.month = month;
            },
            calYear: function (val) {
                //年份的加减运算
                this.year += val;
            },
            validate_date : function (day) {
                //判断当前日期是否是有数据的
                return this.valid_date.indexOf(day)>-1;
            },
            loadData:function (day) {
                var date = this.year * 10000 + this.month * 100 + day;

                //避免重复加载和无效加载
                if(date==this.current_day || !this.validate_date(day)) {
                    return false;
                }
                var data_url = this.data_url+"dateid/"+date+"/user-list.json";
                this.mapv.raw_data = {};
                this.mapv.data = {
                    special_point_list:[],
                    normal_point_list:[],
                    arc_list:[]
                };
                this.user_color_list = {};
                this.$http.get(data_url).then(function (response) {
                    this.current_day = date;
                    this.user_list = response.json();

                    var color_list = ['3FB8AF','FF9E9D','FF3D7F','FA6900','41A1E1'];
                    for(var i in this.user_list) {
                        var rand_index = Math.floor(Math.random() * color_list.length);
                        this.user_color_list[this.user_list[i]] = '#'+color_list[rand_index];
                    }

                    this.loadTripMap(0);
                },function (response) {
                    return false;
                });

                var data_url = this.data_url+"dateid/"+date+"/line.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_1.data['line_data1'] = resp_data['line_data'];
                    this.figure_1.data['line_data2'] = resp_data['line_data2'];
                    this.renderFig1();
                }, function (response) {
                    return false;
                });

                var data_url = this.data_url+"dateid/"+date+"/count.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_2.data['legend_data'] = resp_data['count_legend_data'];
                    this.figure_2.data['count_data'] = resp_data['count_data'];
                    this.renderFig2();
                }, function (response) {
                    return false;
                });

                var data_url = this.data_url+"dateid/"+date+"/duration.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_3.data['legend_data'] = resp_data['duration_legend_data'];
                    this.figure_3.data['duration_data'] = resp_data['duration_data'];
                    this.renderFig3();
                }, function (response) {
                    return false;
                });
            },
            renderData: function () {
                this.renderMap();
                this.renderFig1();
                this.renderFig2();
                this.renderFig3();

            },
            convertMapData: function (user, points_data) {
                var special_point_list = [];
                var normal_point_list = [];
                var arc_list = {coords:[],lineStyle:{}};
                for(var i=0; i<points_data.length; i++) {
                    var point = {
                        name:points_data[i]['label'],
                        value:points_data[i]['coords'],
                        itemStyle: {normal: {color:this.user_color_list[user]}},
                    };
                    if(points_data[i]["is_special"]===true) {
                        special_point_list.push(point);
                    } else {
                        normal_point_list.push(point);
                    }
                    arc_list.coords.push(points_data[i]['coords'])
                }
                arc_list['lineStyle'] = {normal:{color:this.user_color_list[user]}};

                this.mapv.data.special_point_list = this.mapv.data.special_point_list.concat(special_point_list);
                this.mapv.data.normal_point_list = this.mapv.data.normal_point_list.concat(normal_point_list);
                this.mapv.data.arc_list.push(arc_list);
            },
            loadTripMap: function (user) {
                this.mapv.data = {
                    special_point_list:[],
                    normal_point_list:[],
                    arc_list:[]
                };
                var user_list = [];
                if(user===0) {
                    this.current_user= '全部';
                    user_list = this.user_list;
                } else {
                    this.current_user = user;
                    user_list = [user];
                }

                //需要使用闭包避免异步程序完成后变量值覆盖
                user_list.forEach(function (item, index) {
                    var user = item;
                    if(app.mapv.raw_data[user]===undefined) {
                        var data_url = app.data_url+"dateid/"+app.current_day+"/" + user + "/point.json";
                        Vue.http.get(data_url).then(function (response) {
                            app.mapv.raw_data[user] = response.json();
                            app.convertMapData( user, app.mapv.raw_data[user] );
                            app.renderMap(user);
                        }, function (response) {
                            return false;
                        });
                    } else {
                        app.convertMapData( user, app.mapv.raw_data[user] );
                        app.renderMap(user);
                    }
                });

            },
            renderMap: function (user) {
                //this.mapv.el._map.centerAndZoom(new BMap.Point(116.406833, 39.91527), 10);
                if(this.current_user=='全部') {
                    if(Object.keys(this.mapv.raw_data).length !==this.user_list.length) {
                        return false;
                    }
                }

                var special_point_config = {
                    type: "effectScatter",
                    label: {normal: {show: true, position: 'right', formatter: '{b}'}},
                    itemStyle: {normal: {color:"#e7c4f2"}},
                    effectType: "ripple",
                    coordinateSystem: "bmap",
                    symbolSize:5,
                    data: this.mapv.data.special_point_list
                };
                var normal_point_config = {
                    type:'scatter',
                    label: {normal: {show: true, position: 'right', formatter: '{b}'}},
                    itemStyle: {normal: {color:"#e7c4f2"}},
                    symbol: 'circle',
                    coordinateSystem: "bmap",
                    symbolSize: 4,
                    data: this.mapv.data.normal_point_list
                };
                var line1_config = {
                    type: 'lines',
                    coordinateSystem: 'bmap',
                    polyline: true,
                    data: this.mapv.data.arc_list,
                    silent: true,
                    lineStyle: {normal: {opacity: 0.4, width: 3}},
                    progressiveThreshold: 500,
                    progressive: 200
                };
                var line2_config = {
                    type: 'lines',
                    coordinateSystem: 'bmap',
                    polyline: true,
                    data: this.mapv.data.arc_list,
                    lineStyle: {normal: {width: 0}},
                    effect: {constantSpeed: 50, show: true, trailLength: 0.2, symbolSize: 4},
                    zlevel: 1
                };
                var series = [special_point_config,normal_point_config,line1_config,line2_config];
                //var series = [special_point_config,normal_point_config];
                option = {
                    bmap: {
                        center: [116.406833, 39.91527],
                        zoom: 12,
                        roam: true,
                        mapStyle: {
                            'styleJson': map_style
                        }
                    },
                    backgroundColor: '#404a59',
                    title : {
                        text: '模拟迁徙',
                        subtext: '数据纯属虚构',
                        left: 'center',
                        textStyle : {
                            color: '#fff'
                        }
                    },
                    series: series
                };

                this.mapv.el.setOption(option);
            },
            renderFig1: function () {
                var option = {
                    title : {text: '全样本每小时停留点数量(24小时)', textStyle:{color:'#5d5d5d'}},
                    tooltip: {trigger: 'axis'},
                    toolbox: {
                        feature: {
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    legend: {data:['信令数据量','信令数据量2'], textStyle:{color:'#5d5d5d'}},
                    xAxis: [
                        {
                            type : 'category',
                            splitLine:{
                                show:false
                            },
                            boundaryGap : [0, 0.01],
                            data : ['1:00','2:00','3:00','4:00','5:00','6:00','7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00'],
                            axisLabel:{textStyle:{color:'#5d5d5d'}}
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '百次',
                            splitLine:{
                                show:true
                            },
                            axisLabel:{textStyle:{color:'#5d5d5d'}}

                        }
                    ],
                    series: [
                        {
                            name:'信令数据量',
                            type:'bar',
                            data:this.figure_1.data.line_data1,
                            itemStyle: {
                                normal: {color: 'rgba(124,181,236,0.7)'}
                            }
                        },
                        {
                            name:'信令数据量2',
                            type:'line',
                            data:this.figure_1.data.line_data2,
                            itemStyle: {
                                normal: {color: 'rgba(67,67,72,0.7)'}
                            }
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                this.figure_1.el.setOption(option);
            },
            renderFig2: function () {
                option = {
                    title : {text: '用户停留点数量分布', x:'center'},
                    tooltip : {trigger: 'item', formatter: "{a} <br/>{b} : {c} ({d}%)"},
                    backgroundColor: '#ffffff',
                    legend: {
                        orient: 'horizontal',
                        bottom: "bottom",
                        data: this.figure_2.data.legend_data
                    },
                    series : [
                        {
                            name: '',
                            type: 'pie',
                            radius : '40%',
                            center: ['50%', '50%'],
                            data: this.figure_2.data.count_data,
                            itemStyle: {
                                emphasis: {shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)'}
                            }
                        }
                    ]
                };
                this.figure_2.el.setOption(option);
            },

            renderFig3: function () {
                option = {
                    title : {text: '用户停留时长分布', x:'center'},
                    color: ['#3398DB'],
                    backgroundColor: '#ffffff',
                    tooltip : {
                        trigger: 'axis',
                        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis : [
                        {
                            type : 'category',
                            data : this.figure_3.data.legend_data,
                            axisTick: {alignWithLabel: true}
                        }
                    ],
                    yAxis : [
                        {type : 'value'}
                    ],
                    series : [
                        {
                            name:'时长',
                            type:'bar',
                            barWidth: '60%',
                            data:this.figure_3.data.duration_data
                        }
                    ]
                };
                this.figure_3.el.setOption(option);
            }
        },
    });

</script>
</body>
</html>