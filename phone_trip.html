<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="assets/pure-0.6.0-min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="assets/style.css">

    <script src='assets/jquery-3.1.0.slim.min.js'></script>
    <script src="assets/vue.js"></script>
    <script src="assets/vue-resource-0.9.3.min.js"></script>
    <script src="data/date/date_list.js"></script>
    <script src="assets/map_style.js"></script>
    <script src="//cdn.bootcss.com/echarts/3.2.2/echarts.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=30pq91QAo0Cp7izhHpgmgvR8"></script>

    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>

</head>
<body>
<div id="menu-btn"><i class="material-icons">menu</i></div>
<div class="pure-menu" id="left-nav">
    <div class="pure-menu-title">
        数据分析
        <div id="hide-menu-btn"><i class="material-icons">chevron_left</i></div>
    </div>

    <ul class="pure-menu-list">
        <li class="pure-menu-heading"><a href="index.html" class="pure-menu-link">数据概况</a></li>
        <li class="pure-menu-heading  current"><a href="#" class="pure-menu-link">单日出行链</a></li>
        <li class="pure-menu-heading"><a href="#" class="pure-menu-link">出行模式</a></li>
        <li class="pure-menu-heading"><a href="#" class="pure-menu-link">区域分析</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">居住地</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">工作地</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">休闲地</a></li>
        <li class="pure-menu-heading"><a href="#" class="pure-menu-link">OD分析</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">居住地</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">工作地</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">休闲地</a></li>
    </ul>
</div>
<div class="container">

    <div class="right-col">
        <div class="panel">
            <div id="calendar">
                <div class="headbar">
                    <div class="control" v-on:click="calYear(-1)"><i class="material-icons">first_page</i></div>
                    <div class="control" v-on:click="calMonth(-1)"><i class="material-icons">chevron_left</i></div>
                    <div class="control date-title">
                        <div class="year">{{ year }} 年</div>
                        <div class="month">&nbsp;{{ month }} 月</div>
                    </div>
                    <div class="control" v-on:click="calMonth(1)"><i class="material-icons">chevron_right</i></div>
                    <div class="control" v-on:click="calYear(1)"><i class="material-icons">last_page</i></div>
                </div>

                <table class="week">
                    <thead>
                    <tr>
                        <th v-for="day_name in day_name_list">{{ day_name }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="week in week_list">

                        <td v-for="day in week" v-bind:class="{'has-data' : validate_date(day), 'current': year*10000+month*100+day==current_day}" v-on:click="loadData(day)"><a v-if="day > 0">{{ day }}</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel" id="fig-2" style="height: 300px;">

        </div>
        <div class="panel" id="fig-3" style="height: 300px;">

        </div>
    </div>

    <div class="left-col">
        <div class="panel" style="height: 594px;">
            <div class="omnibox-container">
                <div class="omnibox">
                    <div class="resultbox">
                        <i class="material-icons">account_box</i>
                        <div class="result">全部</div>
                        <i class="material-icons arrow">keyboard_arrow_down</i>
                    </div>
                    <ul class="suggestion-list">
                        <li class="suggestion" v-for="user in user_list" v-on:click="loadTripMap(user)">{{ user }}</li>
                    </ul>
                </div>
            </div>
            <div id="bmap" style="height: 100%;">

            </div>
        </div>

        <div class="panel" style="height: 300px;">
            <div id="fig-1" style="height: 100%"></div>
        </div>
    </div>
</div>
<script>
    var planePath = 'path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z';

    $("#menu-btn").click(function () {
        $("#left-nav").addClass("is-visible");
    });
    $("#hide-menu-btn").click(function () {
        $("#left-nav").removeClass("is-visible");
    });
    $(".arrow").click(function () {
        $(".resultbox").toggleClass("list-shown");
        $(".arrow").toggleClass("upward");
        $(".suggestion-list").toggle();
    })
    Vue.config.devtools = true;

    var app = new Vue({
        el:'body',
        data: {
            year : 0,
            month : 0,
            day_name_list : ['一','二','三','四','五','六','日'],
            valid_date: [],
            data_url: 'http://192.168.33.10/dv/data/',
            user_list:[],
            mapv:{
                el:{},
                data:{}
            },
            figure_1:{
                el:{},
                data: {}
            },
            figure_2:{
                el:{},
                data: {}
            },
            figure_3:{
                el:{},
                data: {}
            },
            current_day:-1
        },
        computed: {
            week_list: function () {
                var d= new Date(this.year, this.month, 0);
                var day_num =  d.getDate();
                var first_day = new Date(this.year, this.month-1, 1);
                var first_day_name = first_day.getDay()==0?7:first_day.getDay();
                var week_num = Math.ceil((day_num - (8 - first_day_name)) / 7.0) + 1;
                var week_list = [];
                var day_index = 1;

                var first_week = [];
                for(var i=1;i<first_day_name;i++) {
                    first_week.push(0-i);
                }
                for(var i=first_day_name;i<8;i++) {
                    first_week.push(day_index++);
                }
                week_list.push(first_week);

                for(var i=1;i<week_num;i++) {
                    var week = [];
                    for(var j=1;j<8 && day_index<=day_num;j++) {
                        week.push(day_index++);
                    }
                    week_list.push(week);
                }

                //计算有数据的日期
                this.valid_date = [];
                for(var i in opt_date) {
                    var f_day = this.year * 10000 + this.month * 100;
                    var t_date = parseInt(opt_date[i][1]);
                    if( t_date > f_day && t_date < f_day+32) {
                        this.valid_date.push(t_date%100);
                    }
                }

                return week_list;
            }
        },
        compiled: function () {
            if(opt_date===undefined) {
                var d = new Date();
                this.year = d.getFullYear();
                this.month = d.getMonth()+1;
            } else {
                this.year = parseInt(opt_date[0][1]/10000);
                this.month = parseInt(opt_date[0][1]/100)%100;
            }

        },
        ready: function () {
//            // 创建Map实例
//            var bmap = new BMap.Map('bmap', {
//                enableMapClick: false,
//                minZoom: 4
//                //vectorMapLevel: 3
//            });
//            bmap.centerAndZoom(new BMap.Point(105.403119, 38.028658), 6);
//            bmap.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
//            bmap.enableContinuousZoom();
//            bmap.setMapStyle({
//                styleJson: map_style
//            });
//            // 第一步创建mapv示例
//            var mapv = new Mapv({
//                drawTypeControl: true,
//                map: bmap  // 百度地图的map实例
//            });
//            this.mapv.el = mapv;
            this.mapv.el = echarts.init(document.getElementById('bmap'));

            this.figure_1.el = echarts.init(document.getElementById('fig-1'));
            this.figure_2.el = echarts.init(document.getElementById('fig-2'));
            this.figure_3.el = echarts.init(document.getElementById('fig-3'));

            this.valid_date = [opt_date[0][1]%100];
            this.loadData(opt_date[0][1]%100);
        },
        methods: {
            calMonth: function (val) {
                //月份的加减运算
                var month = this.month + val;
                if(month<1) {
                    month += 12;
                    this.year -= 1;
                } else if(month>12) {
                    month -= 12;
                    this.year += 1;
                }
                this.month = month;
            },
            calYear: function (val) {
                //年份的加减运算
                this.year += val;
            },
            validate_date : function (day) {
                //判断当前日期是否是有数据的
                return this.valid_date.indexOf(day)>-1;
            },
            loadData:function (day) {
                var date = this.year * 10000 + this.month * 100 + day;

                //避免重复加载和无效加载
                if(date==this.current_day || !this.validate_date(day)) {
                    return false;
                }
                var data_url = this.data_url+"dateid/"+date+"/user-list.json";
                this.$http.get(data_url).then(function (response) {
                    this.current_day = date;
                    this.user_list = response.json();
                },function (response) {
                    return false;
                })

//                var data_url = this.data_url+"date/"+date+"/heat.json";
//                this.$http.get(data_url).then(function (response) {
//                    this.mapv.data = [];
//                    var resp_data = response.json();
//                    for(var i in resp_data['heatdata']) {
//                        this.mapv.data.push({
//                            lng:resp_data['heatdata'][i][0],
//                            lat:resp_data['heatdata'][i][1],
//                            count:resp_data['heatdata'][i][2]*100,
//                        });
//                    }
//                    this.current_day = date;
//                    this.renderMap();
//                }, function (response) {
//                    return false;
//                });

                var data_url = this.data_url+"dateid/"+date+"/line.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_1.data['line_data1'] = resp_data['line_data'];
                    this.figure_1.data['line_data2'] = resp_data['line_data2'];
                    this.renderFig1();
                }, function (response) {
                    return false;
                });

                var data_url = this.data_url+"dateid/"+date+"/count.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_2.data['legend_data'] = resp_data['count_legend_data'];
                    this.figure_2.data['count_data'] = resp_data['count_data'];
                    this.renderFig2();
                }, function (response) {
                    return false;
                });

                var data_url = this.data_url+"dateid/"+date+"/duration.json";
                this.$http.get(data_url).then(function (response) {
                    var resp_data = response.json();
                    this.figure_3.data['legend_data'] = resp_data['duration_legend_data'];
                    this.figure_3.data['duration_data'] = resp_data['duration_data'];
                    this.renderFig3();
                }, function (response) {
                    return false;
                });
            },
            renderData: function () {
                this.renderMap();
                this.renderFig1();
                this.renderFig2();
                this.renderFig3();

            },
            loadTripMap: function (user) {
                console.log(user);
                if(this.mapv.data[user]===undefined) {
                    var data_url = this.data_url+"dateid/"+this.current_day+"/" + user + "/point2.json";
                    this.$http.get(data_url).then(function (response) {
                        this.mapv.data[user] = response.json();
                        this.renderMap(user);
                    }, function (response) {
                        return false;
                    });

                } else {
                    this.renderMap(user);
                }
            },
            renderMap: function (user) {
                //this.mapv.el._map.centerAndZoom(new BMap.Point(116.406833, 39.91527), 10);
                var arc_data = this.mapv.data[user].map(function (arc) {
                    console.log(arc);
                    return {fromName:'1',toName:'2',coords:[arc['from'],arc['to']]};
                });
                var series = [];
                series.push({
                            name: 'beijing' + ' Top10',
                            type: 'lines',
                            zlevel: 1,
                            effect: {
                                show: true,
                                period: 6,
                                trailLength: 0.7,
                                color: '#fff',
                                symbolSize: 3
                            },
                            lineStyle: {
                                normal: {
                                    color: '#ff0000',
                                    width: 0,
                                    curveness: 0.2
                                }
                            },
                            data: arc_data
                        },
                        {
                            name: 'beijing' + ' Top10',
                            type: 'lines',
                            zlevel: 2,
                            effect: {
                                show: true,
                                period: 6,
                                trailLength: 0,
                                symbol: planePath,
                                symbolSize: 15
                            },
                            lineStyle: {
                                normal: {
                                    color: '#ff0000',
                                    width: 1,
                                    opacity: 0.4,
                                    curveness: 0.2
                                }
                            },
                            data: arc_data
                        });


    option = {
        bmap: {
            center: [116.46, 39.92],
            zoom: 10,
            roam: true,
            mapStyle: {
                'styleJson': map_style
            }
        },
        backgroundColor: '#404a59',
        title : {
            text: '模拟迁徙',
            subtext: '数据纯属虚构',
            left: 'center',
            textStyle : {
                color: '#fff'
            }
        },
        tooltip : {
            trigger: 'item'
        },
        legend: {
            orient: 'vertical',
            top: 'bottom',
            left: 'right',
            data:['beijing Top10'],
            textStyle: {
                color: '#fff'
            },
            selectedMode: 'single'
        },
        geo: {
            map: 'china',
            label: {
                emphasis: {
                    show: false
                }
            },
            roam: true,
            itemStyle: {
                normal: {
                    areaColor: '#323c48',
                    borderColor: '#404a59'
                },
                emphasis: {
                    areaColor: '#2a333d'
                }
            }
        },
        series: series
    };

                this.mapv.el.setOption(option);
            },
            renderFig1: function () {
                var option = {
                    title : {text: '全样本每小时停留点数量(24小时)', textStyle:{color:'#5d5d5d'}},
                    tooltip: {trigger: 'axis'},
                    toolbox: {
                        feature: {
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    legend: {data:['信令数据量','信令数据量2'], textStyle:{color:'#5d5d5d'}},
                    xAxis: [
                        {
                            type : 'category',
                            splitLine:{
                                show:false
                            },
                            boundaryGap : [0, 0.01],
                            data : ['1:00','2:00','3:00','4:00','5:00','6:00','7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00'],
                            axisLabel:{textStyle:{color:'#5d5d5d'}}
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '百次',
                            splitLine:{
                                show:true
                            },
                            axisLabel:{textStyle:{color:'#5d5d5d'}}

                        }
                    ],
                    series: [
                        {
                            name:'信令数据量',
                            type:'bar',
                            data:this.figure_1.data.line_data1,
                            itemStyle: {
                                normal: {
                                    color: 'rgba(124,181,236,0.7)'
                                }
                            }
                        },
                        {
                            name:'信令数据量2',
                            type:'line',
                            data:this.figure_1.data.line_data2,
                            itemStyle: {
                                normal: {
                                    color: 'rgba(67,67,72,0.7)'
                                }
                            }

                        }
                    ]
                };


                // 使用刚指定的配置项和数据显示图表。
                this.figure_1.el.setOption(option);
            },
            renderFig2: function () {
                option = {
                    title : {text: '用户停留点数量分布', x:'center'},
                    tooltip : {trigger: 'item', formatter: "{a} <br/>{b} : {c} ({d}%)"},
                    backgroundColor: '#ffffff',
                    legend: {
                        orient: 'horizontal',
                        bottom: "bottom",
                        data: this.figure_2.data.legend_data
                    },
                    series : [
                        {
                            name: '',
                            type: 'pie',
                            radius : '40%',
                            center: ['50%', '50%'],
                            data: this.figure_2.data.count_data,
                            itemStyle: {
                                emphasis: {shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)'}
                            }
                        }
                    ]
                };
                this.figure_2.el.setOption(option);
            },

            renderFig3: function () {
                option = {
                    title : {text: '用户停留时长分布', x:'center'},
                    color: ['#3398DB'],
                    backgroundColor: '#ffffff',
                    tooltip : {
                        trigger: 'axis',
                        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis : [
                        {
                            type : 'category',
                            data : this.figure_3.data.legend_data,
                            axisTick: {
                                alignWithLabel: true
                            }
                        }
                    ],
                    yAxis : [
                        {
                            type : 'value'
                        }
                    ],
                    series : [
                        {
                            name:'时长',
                            type:'bar',
                            barWidth: '60%',
                            data:this.figure_3.data.duration_data
                        }
                    ]
                };
                this.figure_3.el.setOption(option);
            }
        },
    });

</script>
</body>
</html>